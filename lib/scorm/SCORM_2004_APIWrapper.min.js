/****************************************************************************
SCORM_2004_APIwrapper.js
ï¿½ 2000, 2011 Advanced Distributed Learning (ADL). Some Rights Reserved.
*****************************************************************************

Advanced Distributed Learning ("ADL") grants you ("Licensee") a  non-exclusive, 
royalty free, license to use and redistribute this  software in source and binary 
code form, provided that i) this copyright  notice and license appear on all 
copies of the software; and ii) Licensee does not utilize the software in a 
manner which is disparaging to ADL.

This software is provided "AS IS," without a warranty of any kind.  
ALL EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND WARRANTIES, INCLUDING 
ANY IMPLIED WARRANTY OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE OR 
NON-INFRINGEMENT, ARE HEREBY EXCLUDED.  ADL AND ITS LICENSORS SHALL NOT BE LIABLE 
FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, MODIFYING OR 
DISTRIBUTING THE SOFTWARE OR ITS DERIVATIVES.  IN NO EVENT WILL ADL OR ITS LICENSORS 
BE LIABLE FOR ANY LOST REVENUE, PROFIT OR DATA, OR FOR DIRECT, INDIRECT, SPECIAL, 
CONSEQUENTIAL, INCIDENTAL OR PUNITIVE DAMAGES, HOWEVER CAUSED AND REGARDLESS OF THE 
THEORY OF LIABILITY, ARISING OUT OF THE USE OF OR INABILITY TO USE SOFTWARE, EVEN IF 
ADL HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.

*****************************************************************************
*SCORM_2004_APIwrapper.js code is licensed under the Creative Commons
Attribution-ShareAlike 3.0 Unported License.

To view a copy of this license:

     - Visit http://creativecommons.org/licenses/by-sa/3.0/ 
     - Or send a letter to
            Creative Commons, 444 Castro Street,  Suite 900, Mountain View,
            California, 94041, USA.

The following is a summary of the full license which is available at:

      - http://creativecommons.org/licenses/by-sa/3.0/legalcode

*****************************************************************************

Creative Commons Attribution-ShareAlike 3.0 Unported (CC BY-SA 3.0)

You are free to:

     - Share : to copy, distribute and transmit the work
     - Remix : to adapt the work

Under the following conditions:

     - Attribution: You must attribute the work in the manner specified by 
       the author or licensor (but not in any way that suggests that they 
       endorse you or your use of the work).

     - Share Alike: If you alter, transform, or build upon this work, you 
       may distribute the resulting work only under the same or similar 
       license to this one.

With the understanding that:

     - Waiver: Any of the above conditions can be waived if you get permission 
       from the copyright holder.

     - Public Domain: Where the work or any of its elements is in the public 
       domain under applicable law, that status is in no way affected by the license.

     - Other Rights: In no way are any of the following rights affected by the license:

           * Your fair dealing or fair use rights, or other applicable copyright 
             exceptions and limitations;

           * The author's moral rights;

           * Rights other persons may have either in the work itself or in how the 
             work is used, such as publicity or privacy rights.

     - Notice: For any reuse or distribution, you must make clear to others the 
               license terms of this work.

****************************************************************************/
var debug = true;
var output = window.console;
var _NoError = { code: "0", string: "No Error", diagnostic: "No Error" };
var _GeneralException = {
  code: "101",
  string: "General Exception",
  diagnostic: "General Exception",
};
var _AlreadyInitialized = {
  code: "103",
  string: "Already Initialized",
  diagnostic: "Already Initialized",
};
var initialized = true;
var apiHandle = null;
function doInitialize() {
  if (initialized) {
    return "true";
  }
  var a = getAPIHandle();
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nInitialize was not successful."
    );
    return "false";
  }
  var c = a.Initialize("");
  if (c.toString() != "true") {
    var b = ErrorHandler();
    message("Initialize failed with error code: " + b.code);
  } else {
    initialized = true;
  }
  return c.toString();
}
function doTerminate() {
  if (!initialized) {
    return "true";
  }
  var a = getAPIHandle();
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nTerminate was not successful."
    );
    return "false";
  } else {
    var c = a.Terminate("");
    if (c.toString() != "true") {
      var b = ErrorHandler();
      message("Terminate failed with error code: " + b.code);
    }
  }
  initialized = false;
  return c.toString();
}
function doGetValue(d) {
  var a = getAPIHandle();
  var e = "";
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nGetValue was not successful."
    );
  } else {
    if (!initialized && !doInitialize()) {
      var b = ErrorHandler();
      message(
        "GetValue failed - Could not initialize communication with the LMS - error code: " +
          b.code
      );
    } else {
      e = a.GetValue(d);
      var c = ErrorHandler();
      if (c.code != _NoError.code) {
        message("GetValue(" + d + ") failed. \n" + c.code + ": " + c.string);
        e = "";
      }
    }
  }
  return e.toString();
}
function doSetValue(d, f) {
  var a = getAPIHandle();
  var e = "false";
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nSetValue was not successful."
    );
  } else {
    if (!initialized && !doInitialize()) {
      var c = ErrorHandler();
      message(
        "SetValue failed - Could not initialize communication with the LMS - error code: " +
          c.code
      );
    } else {
      e = a.SetValue(d, f);
      if (e.toString() != "true") {
        var b = ErrorHandler();
        message(
          "SetValue(" + d + ", " + f + ") failed. \n" + b.code + ": " + b.string
        );
      }
    }
  }
  return e.toString();
}
function doCommit() {
  var a = getAPIHandle();
  var d = "false";
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nCommit was not successful."
    );
  } else {
    if (!initialized && !doInitialize()) {
      var c = ErrorHandler();
      message(
        "Commit failed - Could not initialize communication with the LMS - error code: " +
          c.code
      );
    } else {
      d = a.Commit("");
      if (d != "true") {
        var b = ErrorHandler();
        message("Commit failed - error code: " + b.code);
      }
    }
  }
  return d.toString();
}
function doGetLastError() {
  var a = getAPIHandle();
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nGetLastError was not successful."
    );
    return _GeneralException.code;
  }
  return a.GetLastError().toString();
}
function doGetErrorString(b) {
  var a = getAPIHandle();
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nGetErrorString was not successful."
    );
    return _GeneralException.string;
  }
  return a.GetErrorString(b).toString();
}
function doGetDiagnostic(b) {
  var a = getAPIHandle();
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nGetDiagnostic was not successful."
    );
    return "Unable to locate the LMS's API Implementation. GetDiagnostic was not successful.";
  }
  return a.GetDiagnostic(b).toString();
}
function ErrorHandler() {
  var b = {
    code: _NoError.code,
    string: _NoError.string,
    diagnostic: _NoError.diagnostic,
  };
  var a = getAPIHandle();
  if (a == null) {
    message(
      "Unable to locate the LMS's API Implementation.\nCannot determine LMS error code."
    );
    b.code = _GeneralException.code;
    b.string = _GeneralException.string;
    b.diagnostic =
      "Unable to locate the LMS's API Implementation. Cannot determine LMS error code.";
    return b;
  }
  b.code = a.GetLastError().toString();
  if (b.code != _NoError.code) {
    b.string = a.GetErrorString(b.code);
    b.diagnostic = a.GetDiagnostic("");
  }
  return b;
}
function getAPIHandle() {
  if (apiHandle == null) {
    apiHandle = getAPI();
  }
  return apiHandle;
}
function findAPI(b) {
  var a = 0;
  while (b.API_1484_11 == null && b.parent != null && b.parent != b) {
    a++;
    if (a > 500) {
      message("Error finding API -- too deeply nested.");
      return null;
    }
    b = b.parent;
  }
  return b.API_1484_11;
}
function getAPI() {
  var a = findAPI(window);
  if (
    a == null &&
    window.opener != null &&
    typeof window.opener != "undefined"
  ) {
    a = findAPI(window.opener);
  }
  if (a == null) {
    message("Unable to find an API adapter");
  }
  return a;
}
function findObjective(c) {
  var b = doGetValue("cmi.objectives._count");
  var d = -1;
  for (var a = 0; a < b; ++a) {
    if (doGetValue("cmi.objectives." + a + ".id") == c) {
      d = a;
      break;
    }
  }
  if (d == -1) {
    message("Objective " + c + " not found.");
    d = b;
    message("Creating new objective at index " + d);
    doSetValue("cmi.objectives." + d + ".id", c);
  }
  return d;
}
function findDataStore(b) {
  var d = doGetValue("adl.data._count");
  var c = -1;
  if (d != null && !isNaN(d)) {
    for (var a = 0; a < d; ++a) {
      if (doGetValue("adl.data." + a + ".id") == b) {
        c = a;
        break;
      }
    }
    if (c == -1) {
      message("Data store " + b + " not found.");
    }
  }
  return c;
}
function message(a) {
  if (debug) {
    output.log(a);
  }
}
